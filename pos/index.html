<!DOCTYPE html>

<html>

<head>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

<link rel="stylesheet" href="/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.css">

<!-- <link rel="stylesheet" href="themes/mwcminiprojecttheme.min.css" /> -->
<!-- <link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" /> -->

<script src="/jquery-2.1.4.min.js"></script>
<script src="/jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script src="cordova.js"></script>

</script>
<script type="text/javascript">

  $support.cors=true;

    var trans_id = "";
    var trans_val = 0;
    var threshold = 500;

    $(document).ready(null_trans());

    function null_trans(){
      trans_id = "";
      trans_val = 0;
    }

    function init_transaction(){
      trans_id = generate_transaction_id();
      //note to self: reset to 0;
      trans_val = 0;
    }

    function generate_transaction_id(){
      trans_id = "";
      var the_date = new Date();
      trans_id = the_date.getTime();
      trans_id += makeid();
      return trans_id;
    }

    function makeid(){
      var text = "";
      var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
      for( var i=0; i < 2; i++ )
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      return text;
    }

    $(function(){
        $("#scanbtn").click(function(){
          if(trans_id==""){
            init_transaction();
          }
            cordova.plugins.barcodeScanner.scan(
                function (result) {
                    getProduct(result.text);
                    // not to self, for web testing
                    // getProduct("83012016");
                },
                function (error) {
                    alert("Scanning failed: " + error);
                }
            );
        });


        $("#addtocartbtn").click(function(){
          //create purchase record: $product_id, $transaction_id, $qty, $price, $unit_price
            add_purchase();
            $("#prod_quantity_display").val("");
        });

        $("#submitbtn").click(function(){
          //create transaction record: $transaction_id, $date, $time, $customer
          if (trans_id!=""){
          add_transaction();
          if (trans_val>=threshold){
            send_discount_code();
          }
            null_trans();
            //empty phone number, ul, and total
            $("#customer_phone").val("");
            $("#total_val_view").html("Total: GHc "+trans_val);
            $("#purchase_list_ul").html("");
        }
        else {
          alert("Scan Product First");
        }

        });
    });

    function send_discount_code() {
      var customer_val = $("#customer_phone").val();
      // alert(customer_val);
      var theUrl="cs.ashesi.edu.gh/class2016/michael-annor/mwc-midsem/ajax-action.php?cmd=3&customer="+customer_val;

      var obj=sendRequest(theUrl);		//send request to the above url
      if(obj.result==1){					//check result

      }else{
          //show error message
          alert("error adding discount code");//err
      }


    }

    function add_transaction() {
      var the_date = new Date();
      var date_val = the_date.getFullYear() + "-" + (the_date.getMonth()+1) + "-" + the_date.getDate();
      var time_val = the_date.getHours() + ":" + the_date.getMinutes() + ":" + the_date.getSeconds();
      var customer_val = $("#customer_phone").val();
      var total_val = trans_val;

      var theUrl="cs.ashesi.edu.gh/class2016/michael-annor/mwc-midsem/ajax-action.php?cmd=2&transid="+trans_id+"&date="+date_val+"&time="+time_val+"&customer="
      +customer_val+"&value="+total_val;

      var obj=sendRequest(theUrl);		//send request to the above url
      if(obj.result==1){					//check result

      }else{
          //show error message
          alert("error adding transaction");//err
      }

    }


    function add_purchase() {
      //create purchase record: $product_id, $transaction_id, $qty, $price, $unit_price
      var product_id = $("#prod_id_display").html();
      var product_name = $("#prod_name_display").html();
      var product_price = $("#prod_price_display").html();
      var product_quantity = $("#prod_quantity_display").val();
      var sum = (product_quantity * product_price);
      if (product_quantity > 0){
      trans_val += sum;
      $("#total_val_view").html("Total: GHc "+trans_val);
      var theUrl="cs.ashesi.edu.gh/class2016/michael-annor/mwc-midsem/ajax-action.php?cmd=4&transid="+trans_id+"&prodid="+product_id+"&qty="+product_quantity+"&unitprice="
      +product_price+"&sumprice="+sum;
      var obj=sendRequest(theUrl);		//send request to the above url
      var purchase_list;
      if(obj.result==1){					//check result
          purchase_list = "";
          purchase_list += "<li class='ui-li-static ui-body-inherit ui-li-has-thumb'><img src='pos_icon.png'><h2>";
          purchase_list += product_name;
          purchase_list += " ["+product_id+"]</h2><p>Price: ";
          purchase_list += product_price;
          purchase_list += "</p>";
          purchase_list += "<p>Quantity: ";
          purchase_list += product_quantity;
          purchase_list += "</p>";
          purchase_list += "<p>Subtotal: GHc ";
          purchase_list += sum;
          purchase_list += "</p></li>";

          $("#purchase_list_ul").append(purchase_list);
        }
      else{
          //show error message
          alert("error adding purchase");//err
      }
    }
    else{
        //show error message, qty less than 1
        // alert("error adding purchase");//err
    }


    }


    function sendRequest(u){
        // Send request to server
        //u a url as a string
        //async is type of request
        // alert(u);
        var obj=$.ajax({url:u,async:false});
        //Convert the JSON string to object
        var result=$.parseJSON(obj.responseText);
        return result;	//return object
    }

    function getProduct(code){
      var theUrl="cs.ashesi.edu.gh/class2016/michael-annor/mwc-midsem/ajax-action.php?cmd=1&productid="+code;
      var obj=sendRequest(theUrl);		//send request to the above url
      if(obj.result==1){					//check result
        var product_name = obj.product[0]['product_name'];
        var product_price = obj.product[0]['product_price'];
        $("#prod_name_display").html(product_name);
        $("#prod_id_display").html(code);
        $("#prod_price_display").html(product_price);

        $("#simulateClick").trigger("click");
      }else{
          //show error message
          alert("error: product not in database");//err
      }
    }
</script>


</head>

<body>
<div data-role="page" id="pageone" data-theme="a">

<div data-role="header">
<h1>Point of Sale</h1>

</div>

<div role="main" class="ui-content">

<!-- <a href="#popupSetQty" data-role=button data-inline=false id="scanbtn">Scan Product</a> -->

<a href="#popupSetQty" data-rel="popup" data-position-to="window"  id="simulateClick" data-transition="pop">

<a href="" id="scanbtn"
class="ui-btn ui-corner-all ui-shadow ui-icon-camera ui-btn-icon-left ui-btn-a"
>Scan Product</a>

<input type="tel" name="customer_phone" id="customer_phone" value="" placeholder="Phone Number" data-theme="a">

<div data-role="popup" id="popupSetQty" data-theme="a" class="ui-corner-all">
  <!-- <form> -->
    <div style="padding:10px 20px;">
      <h3 id="prod_name_display">Product Name</h3>
      <h4>Barcode: <span id="prod_id_display">######</span></h4>
      <h4>Price: GHc <span id="prod_price_display">0.00</span></h4>
      <h5>Please input the quantity</h5>
      <label for="quantity" class="ui-hidden-accessible">Quantity:</label>
      <input type="number" name="quantity" id="prod_quantity_display" value="" placeholder="quantity" data-theme="a">
      <a href="" id="addtocartbtn" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-btn-icon-left ui-icon-shop" data-rel="back" role="button">Add to Cart</a>
    </div>
  <!-- </form> -->
</div>

<!--<a href="#pagetwo" data-role="button">Go To Other</a>-->

<ul data-role="listview" data-inset="true" id="purchase_list_ul" class="ui-listview ui-listview-inset ui-corner-all ui-shadow">

</ul>

<div>
<h2 id="total_val_view" style="float:right;">Total: GHc 0.00</h2>
</div>
<br><br><br><br>
<a href="" data-rel="popup" data-position-to="window" id="submitbtn"
class="ui-btn ui-corner-all ui-shadow ui-icon-shop ui-btn-icon-left ui-btn-a"
data-transition="pop">Submit</a>

</div>


<div data-role="footer"> <h1>Made With Love in Berekuso</h1>
</div> </div>



</body> </html>
